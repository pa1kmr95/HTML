<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Earn Settings</title>
  <style>
    :root {
      font-family: system-ui, sans-serif;
      color: #111827;
      background: #f3f4f6;
    }
    body {
      margin: 0;
      padding: 24px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      padding: 24px 30px;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 22px;
    }
    .sub {
      color: #6b7280;
      font-size: 13px;
      margin-bottom: 18px;
    }
    .section-title {
      margin-top: 20px;
      margin-bottom: 6px;
      font-size: 15px;
      font-weight: 600;
    }
    .field {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }
    label {
      font-weight: 600;
      margin-bottom: 4px;
    }
    input, select {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #f9fafb;
      font-family: inherit;
    }
    input:focus, select:focus {
      border-color: #2563eb;
      outline: none;
      background: #ffffff;
    }
    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 3px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px 20px;
    }
    .save-btn {
      background: #2563eb;
      color: #fff;
      padding: 9px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 20px;
    }
    .save-btn:hover {
      background: #1d4ed8;
    }
    .card-table-wrapper {
      overflow-x: auto;
      background: #f9fafb;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 11px;
      color: #4b5563;
    }
    td input, td select {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 5px 7px;
    }
    .add-row-btn {
      margin-top: 8px;
      padding: 5px 9px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px dashed #9ca3af;
      background: #f9fafb;
      cursor: pointer;
    }
    .add-row-btn:hover {
      background: #f3f4f6;
    }
    .remove-btn {
      border: none;
      background: transparent;
      color: #b91c1c;
      cursor: pointer;
      font-size: 11px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 4px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Client Earn Settings</h1>
  <div class="sub">
    Configure earn settings <b>once per client</b>.  
    Rules will only calculate <b>earn value in ₹</b>; conversion into points is driven by <b>card mappings</b> below.
  </div>

  <!-- CLIENT SELECTOR -->
  <div class="field">
    <label for="clientId">Client / Program</label>
    <select id="clientId">
      <option value="">Select…</option>
      <option value="BANK_HDFC">Bank – HDFC</option>
      <option value="BANK_ICICI">Bank – ICICI</option>
      <option value="RETAIL_X">Retail – X</option>
    </select>
    <div class="hint">
      Choose the client whose earn configuration you want to view or change.
    </div>
  </div>

  <!-- COMMERCIAL SETTINGS -->
  <div class="section-title">Commercial settings (MVP)</div>
  <div class="grid">
    <div class="field">
      <label for="defaultDiscountPct">Default discount %</label>
      <input id="defaultDiscountPct" type="number" step="0.1" min="0" max="100" placeholder="e.g. 5" />
      <div class="hint">
        Used for earn calculations when actual per-order discount is not available in MVP.<br/>
        FinalPrice_incl = SP_incl − (defaultDiscount% × SP_incl).
      </div>
    </div>

    <div class="field">
      <label for="pgRatePct">PG charges % (on final price incl. GST)</label>
      <input id="pgRatePct" type="number" step="0.1" min="0" max="100" placeholder="e.g. 2.0" />
      <div class="hint">
        PG cost = PG% × FinalPrice_incl. Included in total cost when computing net margin.
      </div>
    </div>
  </div>

  <!-- ROUNDING & EVENT LOGIC -->
  <div class="section-title">Rounding & event logic</div>
  <div class="grid">
    <div class="field">
      <label for="defaultRoundingMode">Default rounding mode for points</label>
      <select id="defaultRoundingMode">
        <option value="">Not set</option>
        <option value="FLOOR">Round down</option>
        <option value="CEIL">Round up</option>
        <option value="NEAREST_1">Nearest 1 point</option>
        <option value="NEAREST_50">Nearest 50 points</option>
        <option value="NEAREST_100">Nearest 100 points</option>
      </select>
      <div class="hint">
        Base rules can say “Use client default”, and card mappings can optionally override this per card.
      </div>
    </div>

    <div class="field">
      <label for="earnTriggerEvent">Earn trigger event</label>
      <select id="earnTriggerEvent">
        <option value="PAYMENT_SUCCESS">On Payment Success</option>
        <option value="ORDER_DELIVERED">On Order Delivered</option>
        <option value="RETURN_WINDOW_CLOSED">After Return Window Closes</option>
      </select>
      <div class="hint">
        Controls <b>when</b> points are credited for this client.
      </div>
    </div>

    <div class="field" id="returnWindowField" style="display:none;">
      <label for="returnWindowDays">Return window (days)</label>
      <input id="returnWindowDays" type="number" min="0" placeholder="e.g. 7" />
      <div class="hint">
        Required if trigger = “After Return Window Closes”.
      </div>
    </div>

    <div class="field">
      <label for="ruleDateMatch">Rule date matching</label>
      <select id="ruleDateMatch">
        <option value="ORDER_DATE">Use Order Date</option>
        <option value="TRIGGER_EVENT_DATE">Use Trigger Event Date</option>
      </select>
      <div class="hint">
        Controls which date is used to check rule effective from/to.
      </div>
    </div>
  </div>

  <!-- CARD VARIANT MAPPINGS -->
  <div class="section-title">
    Card variant → point value mapping
    <span class="pill">Required</span>
  </div>
  <div class="field">
    <div class="hint">
      Different card variants can have different point currency strength.<br/>
      The rule engine outputs <b>earn value in ₹</b>; this table defines how many points the customer gets.
    </div>
  </div>

  <div class="card-table-wrapper">
    <table id="cardMappingTable">
      <thead>
        <tr>
          <th style="width: 35%;">Card variant code / name</th>
          <th style="width: 30%;">Point value (₹ per point)</th>
          <th style="width: 25%;">Rounding override (optional)</th>
          <th style="width: 10%;">Actions</th>
        </tr>
      </thead>
      <tbody id="cardMappingBody">
        <!-- Example row; in real app, rows will be loaded from backend for given client -->
        <tr>
          <td>
            <input type="text" class="cm-card-variant" placeholder="e.g. INFNIA" />
          </td>
          <td>
            <input type="number" class="cm-point-value" step="0.01" min="0.01" placeholder="e.g. 0.50" />
          </td>
          <td>
            <select class="cm-rounding-override">
              <option value="">Use client default</option>
              <option value="FLOOR">Round down</option>
              <option value="CEIL">Round up</option>
              <option value="NEAREST_1">Nearest 1 point</option>
              <option value="NEAREST_50">Nearest 50 points</option>
              <option value="NEAREST_100">Nearest 100 points</option>
            </select>
          </td>
          <td>
            <button type="button" class="remove-btn" onclick="removeCardRow(this)">✕</button>
          </td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="add-row-btn" onclick="addCardRow()">+ Add card variant mapping</button>
    <div class="hint" style="margin-top:6px;">
      Engine will use this mapping as:<br/>
      • points_raw = earn_value_rupees ÷ point_value_for_card<br/>
      • rounding = rule_rounding OR card rounding override OR client default rounding.
    </div>
  </div>

  <!-- SAVE BUTTON -->
  <button class="save-btn" type="button">
    Save client settings
  </button>
</div>

<script>
  const earnTrigger = document.getElementById("earnTriggerEvent");
  const returnField = document.getElementById("returnWindowField");

  earnTrigger.addEventListener("change", () => {
    if (earnTrigger.value === "RETURN_WINDOW_CLOSED") {
      returnField.style.display = "block";
    } else {
      returnField.style.display = "none";
    }
  });

  function addCardRow() {
    const tbody = document.getElementById("cardMappingBody");
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <input type="text" class="cm-card-variant" placeholder="e.g. REGALIA" />
      </td>
      <td>
        <input type="number" class="cm-point-value" step="0.01" min="0.01" placeholder="e.g. 0.75" />
      </td>
      <td>
        <select class="cm-rounding-override">
          <option value="">Use client default</option>
          <option value="FLOOR">Round down</option>
          <option value="CEIL">Round up</option>
          <option value="NEAREST_1">Nearest 1 point</option>
          <option value="NEAREST_50">Nearest 50 points</option>
          <option value="NEAREST_100">Nearest 100 points</option>
        </select>
      </td>
      <td>
        <button type="button" class="remove-btn" onclick="removeCardRow(this)">✕</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  function removeCardRow(btn) {
    const tr = btn.closest("tr");
    const tbody = document.getElementById("cardMappingBody");
    if (tbody.rows.length > 1) {
      tbody.removeChild(tr);
    } else {
      // Clear last row instead of removing, to avoid empty table
      tr.querySelector(".cm-card-variant").value = "";
      tr.querySelector(".cm-point-value").value = "";
      tr.querySelector(".cm-rounding-override").value = "";
    }
  }

  // NOTE: In real implementation, when clientId changes:
  // - Frontend should call backend to load existing settings & card mappings,
  //   then populate fields + table rows accordingly.
</script>
</body>
</html>
